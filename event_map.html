<!-- Include some styles from the main site (don't copy these) -->

<meta charset='utf-8'/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel='stylesheet' href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:100,200,300,400,500,600,700&display=swap"/>
<link rel='stylesheet' href="https://fonts.googleapis.com/css?family=Source+Serif+Pro:400,600,700,700i&display=swap"/>
<style>
body {
  font-weight: 200;
  font-size: 18px;
  /* font-family: source-serif-pro,'Source Serif Pro',serif; */
  font-family: 'Source Sans Pro',sans-serif;
  font-style: normal;
  letter-spacing: 0.02em;
  line-height: 1.5em;
  -moz-osx-font-smoothing: auto;
}
b, strong {
  font-weight: bold;
}
h2 {
  font-family: 'Source Sans Pro';
  font-style: normal;
  letter-spacing: 0.125em;
  text-transform: uppercase;
}
h3 {
  line-height: 1.25em;
  text-transform: none;
  letter-spacing: 0.05em;
  font-style: normal;
  font-family: source-serif-pro,'Source Serif Pro',serif;
}
</style>

<!-- Copy from here down -->

<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />

<style>

:root {
  --emap-white: #FFFFFF;
  --emap-black: #33342E;
  --emap-off-white: #F4F4F4;
  --emap-light-grey: #E0E0E0;
  /* --emap-yellow: #FFDE16; */
  --emap-yellow: #FFDD4F;
  --emap-secondary: #8F0D56;
  --emap-secondary2: #E3EDDF;

  --emap-small-font: 15px;
  --emap-large-font: 20px;

  --emap-width: 387px;
  --emap-list-vertical-padding: 2rem;
  --emap-list-horizontal-padding: 2rem;
}

/*
<svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M1 7L6 2L11 7" stroke="#33342E" stroke-width="2"/>
</svg>
*/

/* Vector 1 */

.input {
  margin: 0;
  -moz-appearance: none;
  -webkit-appearance: none;
  align-items: center;
  border: 1px solid transparent;
  border-radius: 4px;
  box-shadow: none;
  display: inline-flex;
  font-size: 1rem;
  height: 2.5em;
  justify-content: flex-start;
  line-height: 1.5;
  padding-bottom: calc(0.5em - 1px);
  padding-left: calc(0.75em - 1px);
  padding-right: calc(0.75em - 1px);
  padding-top: calc(0.5em - 1px);
  position: relative;
  vertical-align: top;
  background-color: white;
  border-color: #dbdbdb;
  border-radius: 4px;
  color: #363636;
  box-shadow: inset 0 0.0625em 0.125em rgba(10, 10, 10, 0.05);
  max-width: 100%;
  width: 100%;
  font-family: BlinkMacSystemFont, -apple-system, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
}
.input::-moz-placeholder,
.input::-webkit-input-placeholder,
.input:-moz-placeholder,
.input:-ms-input-placeholder {
  color: rgba(54, 54, 54, 0.3);
}

.input:hover {
  border-color: #b5b5b5;
}
.input:focus {
  outline: none;
  border-color: #3273dc;
  box-shadow: 0 0 0 0.125em rgba(50, 115, 220, 0.25);
}
.is-medium.input {
  font-size: 1.25rem;
}

.is-large.input {
  font-size: 1.5rem;
}
.is-small.input {
  border-radius: 2px;
  font-size: 0.75rem;
}
.input.is-rounded {
  border-radius: 290486px;
  padding-left: calc(calc(0.75em - 1px) + 0.375em);
  padding-right: calc(calc(0.75em - 1px) + 0.375em);
}

#event-map *::-webkit-search-cancel-button {
  -webkit-appearance: searchfield-cancel-button;
}

#event-map {
  color: var(--emap-black);
}

#event-map .event-card {
  padding: var(--emap-list-vertical-padding) var(--emap-list-horizontal-padding);
  border-bottom: 1px solid #ccc;
}

#event-map .event-card.active {
  background: rgb(255,251,234);
}

#event-map .event-card-header {
  margin-bottom: 15px;
  position: relative;
  min-height: 42px;
}

#event-map .event-card-header-title {
  font-weight: bold;
  font-size: var(--emap-large-font);
  line-height: calc(var(--emap-large-font) + 2px);
  max-width: calc(100% - 6.5rem);
}

#event-map .event-card-header-rsvp {
  right: 0;
  top: 0;
  position: absolute;
}

#event-map .event-button-secondary {
  transition: .1s background linear;
  color: var(--emap-white);
  font-weight: bold;
  text-decoration: none;
  background: var(--emap-secondary);
  text-align: center;

  font-size: var(--emap-small-font);
  line-height: calc(var(--emap-small-font) + 4px);
  padding: 0.75rem 1.5rem;
}
#event-map .event-button-secondary:hover {
  background: #ab4a80;
}

#event-map .event-card-body {
  font-size: var(--emap-small-font);
  line-height: 21px;
  overflow-wrap: break-word;
}
#event-map .event-card-body-date,
#event-map .event-card-body-addr {
  font-weight: 600;
}
#event-map .desc-toggle {
  margin-top: 15px;
}


#event-map .caret {
 width: 12px;
 height: 9px;
 background-position-x: 12px;
 background-position-y: 1px;
 display: inline-block;
 background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%2372726F' stroke-width='2'/%3E%3C/svg%3E%0A"); 
}

#event-map .caret.caret-up {
  transform: matrix(1, 0, 0, -1, 0, 0);
}

#event-map .desc-toggle {
  color: rgb(114,114,111);
  font-weight: bold;
  line-height: 19px;
  cursor: pointer;
}
#event-map .desc-toggle:hover {
  opacity: 0.9;
}
#event-map .desc-open .desc-toggle.desc-toggle-open {
  display: none;
}

#event-map .event-card-body-desc {
  display: none;
}
#event-map .desc-open .event-card-body-desc {
  display: block;
}
#event-map .event-card-body-desc p {
  font-family: "Source Serif Pro";
}

#event-map .event-map-sidebar {
  position: absolute;
  width: var(--emap-width);
  background: var(--emap-white);
  top: 0;
  bottom: 0;
  overflow-y: scroll;
  left: 0;
  z-index: 9999;
  border: 1px solid var(--emap-light-grey);
}

#event-map.is-filtering .is-filtered {
  display: none;
}

#event-map .event-map-map {
  position: absolute;
  width: calc(100% - var(--emap-width));
  top: 0;
  left: var(--emap-width);
  bottom: 0;
  border-top: 1px solid var(--emap-light-grey);
}

#event-map .listings {
  font-family: 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
  background-color: var(--emap-white);
  border: 1px solid var(--emap-white);
  /* padding-top: 103px; */
}

#event-map ::-webkit-scrollbar {
  width:3px;
  height:3px;
  border-left:0;
  background:rgba(0,0,0,0.1);
}
#event-map::-webkit-scrollbar-track {
  background:none;
}
#event-map::-webkit-scrollbar-thumb {
  background:#000;
  border-radius:0;
}

#event-map .marker {
  border: none;
  cursor: pointer;
  width: 28px;
  height: 40px;
  background-image: url(data:image/png;base64,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);
  background-color: rgba(255,255,255,0);
  background-size: cover;
}

#event-map .clearfix { display:block; }
#event-map .clearfix:after {
  content:'.';
  display:block;
  height:0;
  clear:both;
  visibility:hidden;
}

#event-map .event-search-bar {
  position: relative;
}

#event-map .select::after {
  border: 3px solid transparent;
  border-radius: 2px;
  border-right: 0;
  border-top: 0;
  content: " ";
  display: block;
  height: 0.625em;
  margin-top: -0.4375em;
  pointer-events: none;
  position: absolute;
  top: 50%;
  transform: rotate(-45deg);
  transform-origin: center;
  width: 0.625em;
  border-color: #3273dc;
  right: 1.125em;
  z-index: 4;
}

#event-map .select {
  display: inline-block;
  max-width: 100%;
  position: relative;
  vertical-align: top;
  height: 2.5em;
  cursor: pointer;
  font-size: 1em;
  max-width: 100%;
  outline: none;
  font-size: 16px;
}

#event-map .select select::-ms-expand {
  display: none;
}

#event-map .select select {
  -moz-appearance: none;
  -webkit-appearance: none;
  align-items: center;
  border: 1px solid transparent;
  border-radius: 4px;
  box-shadow: none;
  display: inline-flex;
  font-size: 1em;
  height: 2.5em;
  justify-content: flex-start;
  line-height: 1.5;
  padding-bottom: calc(0.5em - 1px);
  padding-left: calc(0.75em - 1px);
  padding-right: calc(0.75em - 1px);
  padding-top: calc(0.5em - 1px);
  position: relative;
  vertical-align: top;
  margin: 0;
  background-color: white;
  border-color: #dbdbdb;
  border-radius: 4px;
  color: #363636;
  padding-right: 2.5em;
}

#event-map .select select:hover {
  border-color: #b5b5b5;
}

#event-map .select:hover::after {
  border-color: #363636;
}

#event-map .select select:focus {
  border-color: #3273dc;
  box-shadow: 0 0 0 0.125em rgba(50, 115, 220, 0.25);
}


#event-map .select select:focus {
  outline: none;
}

#event-map .select.is-small {
  border-radius: 2px;
  font-size: 0.75rem;
}


#event-map .event-map-sideheader {
  background: var(--emap-yellow);
  padding: var(--emap-list-vertical-padding) var(--emap-list-horizontal-padding);
  width: calc(var(--emap-width) - 2*var(--emap-list-horizontal-padding));
  /* position: fixed; */
  z-index: 1;
}

#event-map #event-text-search {
  width: 100%;
}

/* Marker tweaks */
#event-map .mapboxgl-popup {
  padding-bottom: 50px;
}

#event-map .mapboxgl-popup-close-button {
  font-size: 1rem;
}

#event-map .mapboxgl-popup-content {
  font-family: 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
  font-weight: 300;
  font-size: var(--emap-small-font);
  line-height: 22px;
  min-width: 230px;
  border-radius: 10px;
  box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.15);
  max-height: 13rem;
  overflow-y: scroll;
  padding: 18px 20px;
  padding-bottom: 0;
}

#event-map .event-tooltip-header {
  font-size: calc(var(--emap-large-font));
  font-weight: bold;
}

#event-map .event-tooltip + .event-tooltip {
  margin-top: 15px;
  padding-top: 10px;
  border-top: 1px dotted #ccc;
}

#event-map .event-tooltip-body-rsvp a {
  width: 100%;
  display: block;
  padding: 5px 0px;
}

#event-map .event-tooltip-body-time {
  font-size: 15px;
  font-weight: 600;
  margin-top: 3px;
  margin-bottom: 7px;
}

#event-map .mapboxgl-popup-content:after {
  content: "";
  display: block;
  height: 18px;
  width: 100%;
}

#event-map .mapboxgl-container .leaflet-marker-icon {
  cursor:pointer;
}

#event-map .mapboxgl-popup-anchor-top > .mapboxgl-popup-content {
  margin-top: 15px;
}

#event-map .mapboxgl-popup-anchor-top > .mapboxgl-popup-tip {
  border-bottom-color: #fdde33;
}

#event-map .sticky #event-search-wrapper {
  position: fixed;
  top: 1px;
  left: 1px;
  padding: 2rem;
  background: var(--emap-yellow);
  width: calc(var(--emap-width) - 4rem);
  z-index: 1;
}
#event-map .sticky #listings {
  padding-top: calc(2rem + 7px);
}

@media (max-width: 600px) {
  #event-map .event-map-sidebar {
    width: 100%;
  }
  #event-map .event-map-sideheader {
    width: calc(100% - 4rem);
  }
  #event-map .sticky #event-search-wrapper {
    width: calc(100% - 4rem);
  }
  #event-map .event-map-map {
    display: none;
  }
}

@media (max-width: 360px) {
  #event-map .sunrise-logo-movement {
    display: none;
  }
}

#event-map .no-event-message {
  display: none;
}

#event-map .event-map-sidebar.no-events .no-event-message {
  display: block;
  padding: var(--emap-list-vertical-padding) var(--emap-list-horizontal-padding);
}

#event-map .event-map-sideheader .sunrise-logo {
  font-family: 'Source Sans Pro',sans-serif;
  font-weight: bold;
  font-size: 20px;
  vertical-align: top;
  display: inline-block;
  margin-left: 3px;
}
#event-map .event-map-sideheader .sunrise-icon {
  background-image: url("data:image/svg+xml,%3Csvg width='19' height='30' viewBox='0 0 19 30' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0V0.0718592V6.38588V20.7948L9.26471 29.9988L18.5294 20.7948V6.38708V0.0718592V0H0ZM14.8488 4.9499C14.6728 3.59176 14.005 2.38333 13.0285 1.51024H17.0827V4.9499H14.8488ZM17.0827 17.7911L11.8205 8.63987L17.0827 12.8724V17.7911ZM1.44667 12.834L6.75233 8.60154L1.44667 17.7995V12.834ZM8.57272 8.33806L8.55102 27.2586L1.62509 20.3781L8.57272 8.33806ZM10.0194 8.40393L16.9043 20.3781L9.99889 27.2382L10.0194 8.40393ZM5.1417 4.9499C5.48528 2.99772 7.2032 1.51024 9.26471 1.51024C11.3262 1.51024 13.0441 2.99892 13.3877 4.9499H5.1417ZM1.44667 4.9499V1.50904H5.50096C4.52446 2.38213 3.85658 3.59056 3.68057 4.9487H1.44667V4.9499ZM3.63234 6.38708H7.22008L1.44667 10.9909V6.38708H3.63234ZM17.0827 11.022L11.319 6.38708H14.8983H17.084V11.022H17.0827Z' fill='%2333342E'/%3E%3C/svg%3E%0A");
  width: 19px;
height: 30px;
display: inline-block;
transform: scale(0.9);
}

#event-map .event-map-sideheader p {
  font-size: 13px;
  font-family: 'Source Serif Pro', serif;
  line-height: 19px;
}

</style>

<div id="event-map">
  <div class='event-map-sidebar' id='event-list-sidebar'>
    <div class='event-map-sideheader'>
      <div class='event-search-bar'>
        <span class='sunrise-icon'></span>
        <div class='sunrise-logo'>SUNRISE <span class='sunrise-logo-movement'>MOVEMENT</span> EVENTS</div>
        <p class='search-text'>Use the searchbar below to find trainings, rallies, canvasses, and other events!</p>
        <div id='event-search-wrapper'>
          <input id='event-text-search' class='input' type='search' placeholder='Filter by zip, city, state, or name'>
        </div>
      </div>
    </div>
    <div id='listings' class='listings'>
      <div class='no-event-message'>
        <strong>No events found. Try another search!</strong>
      </div>
    </div>
  </div>
  <div id='map' class='event-map-map'>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>

<script>

const sidebar = document.getElementById('event-list-sidebar');
const searchwrap = document.getElementById('event-search-wrapper');
const threshold = searchwrap.offsetTop - 17;

sidebar.addEventListener("scroll", () => {
  if (sidebar.scrollTop > threshold) {
    sidebar.classList.add("sticky");
  } else {
    sidebar.classList.remove("sticky");
  }
});

if (typeof(String.prototype.trim) === "undefined") {
  String.prototype.trim = function() {
    return String(this).replace(/^\s+|\s+$/g, '');
  };
}

if (typeof(Array.prototype.unique) === "undefined") {
  Array.prototype.unique = function() {
    return this.filter(function (value, index, self) {
      return self.indexOf(value) === index;
    });
  }
}

function haversineDistance(coords1, coords2, isMiles) {
  function toRad(x) {
    return x * Math.PI / 180;
  }
  var lat1 = coords1[0];
  var lon1 = coords1[1];
  var lat2 = coords2[0];
  var lon2 = coords2[1];
  var R = 6371; // km
  var x1 = lat2 - lat1;
  var dLat = toRad(x1);
  var x2 = lon2 - lon1;
  var dLon = toRad(x2)
  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  var d = R * c;
  if(isMiles) d /= 1.60934;
  return d;
}

const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

function parseDate(d) {
  const parts = d.split('T')[0].split('-');
  const year = parseInt(parts[0]);
  const month = parseInt(parts[1]);
  const day = parseInt(parts[2]);
  return {
    m: month,
    d: day,
    y: year,
  }
}

function dateStr(d) {
  const pd = parseDate(d);
  const monthName = monthNames[pd.m-1];
  return `${monthName} ${pd.d}, ${pd.y}`;
}

function dateRangeStr(d1, d2) {
  if (!d2) {
    return dateStr(d1);
  }
  const p1 = parseDate(d1);
  const p2 = parseDate(d2);
  const m1 = monthNames[p1.m-1];
  const m2 = monthNames[p2.m-1];
  if (p1.d == p2.d && p1.m == p2.m && p1.y == p2.y) {
    return dateStr(d1);
  } else if (p1.m == p2.m && p1.y == p2.y) {
    return `${m1} ${p1.d} - ${p2.d}, ${p1.y}`;
  } else if (p1.y == p2.y) {
    return `${m1} ${p1.d} - ${m2} ${p2.d}, ${p1.y}`;
  } else {
    return `${dateStr(d1)} - ${dateStr(d2)}`;
  }
}

function timeStr(d) {
  const parts = d.split(/[T\.]/)[1].split(':');
  let hour = parseInt(parts[0]);
  let period;
  let minute = parseInt(parts[1]);
  if (hour == 0) {
    period = 'AM';
    hour = 12;
  } else if (hour == 12) {
    period = 'PM';
  } else if (hour > 12) {
    period = 'PM';
    hour = hour - 12;
  } else {
    period = 'AM';
  }
  if (minute < 10) {
    minute = `0${minute}`;
  }
  return `${hour}:${minute} ${period}`;
}

function htmlEscape(s) {
  if (!s) return '';
  return s.
    replace(/&/g, "&amp;").
    replace(/</g, "&lt;").
    replace(/>/g, "&gt;").
    replace(/"/g, "&quot;").
    replace(/'/g, "&#x27;").
    replace(/\//g, "&#x2F;");
}

function linkEscape(s) {
  if (!s) return '';
  const escaped = s.trim().
    replace(/</g, "&lt;").
    replace(/>/g, "&gt;").
    replace(/"/g, "&quot;").
    replace(/'/g, "&#x27;");
  if (escaped.match(/^\s*javascript/i))
    return '';
  else if (escaped.match(/^bit\.ly/))
    return 'https://'+escaped;
  else
    return escaped;
}

function utmTag(link, content) {
  var url = new URL(link);
  const utmParams = `utm_source=event-map&utm_content=${content}`;

  if (url.search) {
    url.search += `&${utmParams}`;
  } else {
    url.search = utmParams;
  }

  return url.toString();
}

function eventAddress(ev) {
  const parts = [];

  if (ev.location_name) {
    parts.push(htmlEscape(ev.location_name));
  }

  //if (ev.address) {
  //  parts.push(htmlEscape(ev.address));
  //}

  if (ev.city && ev.state && ev.zip_code) {
    parts.push(`${htmlEscape(ev.city)}, ${htmlEscape(ev.state)} ${htmlEscape(ev.zip_code)}`);
  } else if (ev.city && ev.state) {
    parts.push(`${htmlEscape(ev.city)}, ${htmlEscape(ev.state)}`);
  } else if (ev.state) {
    parts.push(htmlEscape(ev.state));
  }

  if (parts.length) {
    return `<div class='event-card-body-addr'>
      ${parts.join("<br>")}
    </div>`;
  } else {
    return "";
  }
}

function eventDesc(ev) {
  if (ev.description) {
    return `<div class='desc-toggle desc-toggle-open'>
      More info <span class='caret caret-down'></span>
    </div>
    <div class='event-card-body-desc'>
      <div class='desc-toggle desc-toggle-close'>
        Less info <span class='caret caret-up'></span>
      </div>
      <p>${htmlEscape(ev.description)}</p>
    </div>`;
  } else {
    return "";
  }
}

function eventCard(ev) {
  return `<div class='event-card-header'>
    <a target='_blank' href='${linkEscape(utmTag(ev.registration_link, "list"))}' class='event-card-header-rsvp event-button-secondary'>RSVP</a>
    <div class='event-card-header-title'>
      ${htmlEscape(ev.event_title)}
    </div>
  </div>
  <div class='event-card-body'>
    <div class='event-card-body-date'>
      ${dateRangeStr(ev.start_date, ev.end_date)} at ${timeStr(ev.start_date)}
    </div>
    ${eventAddress(ev)}
    ${eventDesc(ev)}
  </div>`;
}

function eventTooltip(ev) {
  return `<div class='event-tooltip'>
    <div class='event-tooltip-header'>
      ${htmlEscape(ev.event_title)}
    </div>
    <div class='event-tooltip-body'>
      <div class='event-tooltip-body-time'>
        ${dateRangeStr(ev.start_date, ev.end_date)} at ${timeStr(ev.start_date)}
      </div>
      <div class='event-tooltip-body-rsvp'>
        <a class='event-button-secondary' target='_blank' href='${linkEscape(utmTag(ev.registration_link, "map"))}'>RSVP</a>
      </div>
    </div>
  </div>`;
}

function geoJSONFeature(t) {
  return {
    "type": "Feature",
    "geometry": {
      "type": "Point",
      "coordinates": [t.longitude, t.latitude]
    },
    "properties": t
  }
}

function sample(array) {
  return array[Math.floor(Math.random()*array.length)];
}

function eventMatches(eventSearch, ev) {
  for (let es of eventSearch.split('|'))
    for (let field of ['zip_code', 'event_title', 'city', 'state', 'location_name'])
      if ((ev[field] || '').toLowerCase().includes(es.toLowerCase().trim()))
        return true;
  return false;
}

$(document).ready(function() {
  $.ajax({
      type: "GET",
      url: "https://sunrise-events.s3.amazonaws.com/events.json",
      dataType: "json",
      success: function(data) {
        const search = new URLSearchParams(location.search);

        let mapData = data.map_data;

        if (search.get('state')) {
          mapData = mapData.filter(ev => ev.state == search.get('state'));
        }
        if (search.get('campaign') && search.get('also_include')) {
          mapData = mapData.filter(ev => ev.campaign == search.get('campaign') || eventMatches(search.get('also_include'), ev));
        } else if (search.get('campaign')) {
          mapData = mapData.filter(ev => ev.campaign == search.get('campaign'));
        } else if (search.get('also_include')) {
          mapData = mapData.filter(ev => eventMatches(search.get('also_include'), ev));
        }

        if (search.get('header_text')) {
          $('.sunrise-logo').text(search.get('header_text'));
          $('.sunrise-icon').remove();
        } else if (search.get('state')) {
          $('.sunrise-logo-movement').text(search.get('state'));
        }

        if (search.get('filter_text')) {
          $('.search-text').text(search.get('filter_text'));
        }

        initMap(mapData);
      }
   });
});

function initMap(events) {

  var map = new mapboxgl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'raster-tiles': {
          type: 'raster',
          tiles: [
            'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'
          ],
          tileSize: 256,
          attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        }
      },
      layers: [
        {
          id: 'simple-tiles',
          type: 'raster',
          source: 'raster-tiles',
          minzoom: 0,
          maxzoom: 22
        }
      ]
    },
    center: [-112.030293, 39.585733],
    zoom: 2.5
  });

  // Add zoom and rotation controls to the map.
  map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

  var eventsByPos = {};
  var keys = [];

  for (var i = 0; i < events.length; i++) {
    var event = events[i];
    event['index'] = i;
    if (event.latitude === null) {
      continue;
    }
    var key = `${event.latitude}, ${event.longitude}`;
    if (!eventsByPos[key]) {
      eventsByPos[key] = {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [event.longitude, event.latitude]
        },
        "properties": {
          "events": []
        }
      };
      keys.push(key);
    }
    eventsByPos[key].properties.events.push(event);
  }

  var features = [];
  for (var i = 0; i < keys.length; i++) {
    var feature = eventsByPos[keys[i]];
    feature.properties.searchKey = '';
    for (var j = 0; j < feature.properties.events.length; j++) {
      var event = feature.properties.events[j];
      event['position'] = i;
      event['subindex'] = j;
      feature.properties.searchKey += `e${event.index}_`;
    }

    features.push(feature);
  }

  map.on('load', function (e) {
    map.addSource("places", {
      "type": "geojson",
      "data": {
        "type": "FeatureCollection",
        "features": features
       }
    });

    resetFilters();
  });

  function setQueryParam(name, value) {
    const params = new URLSearchParams(window.location.search);
    params.set(name, value);
    window.history.replaceState({}, "", decodeURIComponent(`${window.location.pathname}?${params}`));
  }

  buildLocationList(features, events);

  $('.desc-toggle').click((ev) => {
    $(ev.currentTarget).closest('.event-card').toggleClass('desc-open');
    return false;
  });

  let zipCodesPromise = null
  const zipCodesUrl = 'https://sunrise-events.s3.amazonaws.com/zip_codes.json';
  /**
   * @returns {Promise<{ [zip: string]: [number, number] }}>} a mapping of zipcode to [lat, lng]
   */
  const loadZipCodes = () => {
    if (zipCodesPromise === null) {
      zipCodesPromise = fetch(zipCodesUrl).then((response) => response.json())
    }
    return zipCodesPromise
  }

  function resetFilters() {
    const params = new URLSearchParams(window.location.search);
    const eventSearch = params.get('filter') || '';
    $('#event-text-search').val(eventSearch);

    if (eventSearch) {
      $('#event-map').addClass('is-filtering');
    } else {
      $('#event-map').removeClass('is-filtering');
    }

    let minLat = 71.3577635769;
    let maxLat = 18.91619;
    let minLng = -66.96466;
    let maxLng = -171.791110603;

    $('.event-card').addClass('is-filtered');
    $('.marker').addClass('is-filtered');

    const trimmedSearch = eventSearch.trim();
    const isProbablyZipCode = /^\d{3,5}$/g.test(trimmedSearch);

    // We only want to load the zip codes for the first time if we think the user is actually
    // searching for a zip code. It's a big file, folks!
    const loadedZipCodes = isProbablyZipCode ?
      loadZipCodes() :
      Promise.resolve({});

      loadedZipCodes.then((zipCodes) => {
      const zipCoords = [];
      for (const zip in zipCodes) {
        if (zip.startsWith(trimmedSearch)) zipCoords.push(zipCodes[zip]);
      }

      const searchRadius = (
        params.get('radius') ||
        params.get('radiusKm') ||
        params.get('radiusKM') ||
        25
      );

      const remainingEvents = events.filter((ev) => {
        // If there's no search, everything is displayed
        if (!eventSearch) return true;

        // If one of the specified fields is an exact text match, display it
        if (eventMatches(eventSearch, ev)) return true;

        // If the search text includes a zip code and we're within 25km, display it
        for (let coord of zipCoords) {
          const distance = haversineDistance(coord, [ev.latitude, ev.longitude]);
          if (distance <= searchRadius) {
            return true;
          }
        }

        return false;
      });

      remainingEvents.forEach((ev) => {
        $(`#listing-${ev.index}`).removeClass('is-filtered');
        $(`.marker[data-search*='e${ev.index}_']`).removeClass('is-filtered');
        if (ev.latitude !== null) {
          minLat = Math.min(minLat, ev.latitude);
          maxLat = Math.max(maxLat, ev.latitude);
          minLng = Math.min(minLng, ev.longitude);
          maxLng = Math.max(maxLng, ev.longitude);
        }
      });

      if (remainingEvents.length) {
        $("#event-list-sidebar").removeClass("no-events");
      } else {
        $("#event-list-sidebar").addClass("no-events");
      }

      const bounds = [[minLng, minLat], [maxLng, maxLat]];

      map.fitBounds(bounds, {
        padding: 75,
        linear: true,
        maxZoom: 7
      });
    });
  }

  $('#event-text-search').on('input change', (jsEv) => {
    setQueryParam('filter', $(jsEv.currentTarget).val());
    resetFilters();
  });

  map.on('moveend', function() {
    var my = $('#event-map .mapboxgl-popup')[0];
    if (typeof my !== "undefined") {
      my.style.transform = my.style.transform.replace("-50%", "calc(-50% - 0.5px)");
    }
  });

  // This is where your interactions with the symbol layer used to be
  // Now you have interactions with DOM markers instead
  features.forEach(function(marker, i) {
    // Create an img element for the marker
    var el = document.createElement('div');
    el.id = "marker-" + i;
    el.className = 'marker';
    el.setAttribute('data-search', marker.properties.searchKey);
    // Add markers to the map at all points
    new mapboxgl.Marker(el, {offset: [0, -23]})
        .setLngLat(marker.geometry.coordinates)
        .addTo(map);

    el.addEventListener('click', function(e){
        // 1. Close all other popups and display popup for clicked store
        createPopUp(marker);

        // 2. Fly to the point
        flyToStore(marker);

        // 3. Highlight listing in sidebar (and remove highlight for all other listings)
        e.stopPropagation();
        $('#event-map .active').removeClass('active');

        var link = $(`#listing-${marker.properties.events[0].index}`);
        if (link.length) {
          $(link[0]).addClass('active');
          link[0].scrollIntoView({ block: 'center', inline: 'start' });
        }
    });
  });

  function flyToStore(currentFeature) {
    if (currentFeature) {
      map.flyTo({ center: currentFeature.geometry.coordinates });
    }
  }

  function createPopUp(currentFeature) {
    var popUps = document.getElementsByClassName('mapboxgl-popup');
    if (popUps[0]) popUps[0].remove();

    var ts = currentFeature.properties.events;
    var popupHtml = '<div class="events-sublist">';
    for (var i = 0; i < ts.length; i++) {
      var t = ts[i];
      popupHtml += eventTooltip(t);
    }
    popupHtml += '</div>';

    var popup = new mapboxgl.Popup({ closeOnClick: true, anchor: "bottom" })
      .on('close', function() { $('#event-map .event-card').removeClass('active'); })
      .setLngLat(currentFeature.geometry.coordinates)
      .setHTML(popupHtml)
      .addTo(map);
  }

  function buildLocationList(features, events) {
    for (var i = 0; i < events.length; i++) {
      var t = events[i];
      var listings = document.getElementById('listings');
      var listing = listings.appendChild(document.createElement('div'));
      listing.id = "listing-" + t.index;
      listing.className = "event-card";
      listing.innerHTML = eventCard(t);
      listing.dataPosition = t.position;
      listing.dataSubindex = t.subindex;

      listing.addEventListener('click', function(e){
        // Update the currentFeature to the store associated with the clicked link
        var clickedListing = features[this.dataPosition];
        var j = this.dataSubindex;

        // 1. Fly to the point
        flyToStore(clickedListing);

        return;

        // 2. Close all other popups and display popup for clicked store
        createPopUp(clickedListing);

        // 3. Highlight listing in sidebar (and remove highlight for all other listings)
        $('#event-map .active').removeClass('active');
        $(this).addClass('active');

        // 4. scroll to entry if it's not visible
        var sublisting = $(`.events-sublist .event-tooltip:nth-child(${j+1})`);
        if (j > 0 && sublisting.length) {
          sublisting[0].scrollIntoView({block: "nearest", inline: "start"});
        }
      });
    }
  }

  return;
}
</script>
