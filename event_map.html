<!-- Include some styles from the main site (don't copy these) -->

<meta charset='utf-8'/>
<link rel='stylesheet' href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:100,200,300,400,500,600,700&display=swap"/>
<link rel='stylesheet' href="https://fonts.googleapis.com/css?family=Source+Serif+Pro:400,600,700,700i&display=swap"/>
<style>
body {
  font-weight: 200;
  font-size: 18px;
  //font-family: source-serif-pro,'Source Serif Pro',serif;
  font-family: 'Source Sans Pro',sans-serif;
  font-style: normal;
  letter-spacing: 0.02em;
  line-height: 1.5em;
  -moz-osx-font-smoothing: auto;
}
b, strong {
  font-weight: bold;
}
h2 {
  font-family: 'Source Sans Pro';
  font-style: normal;
  letter-spacing: 0.125em;
  text-transform: uppercase;
}
h3 {
  line-height: 1.25em;
  text-transform: none;
  letter-spacing: 0.05em;
  font-style: normal;
  font-family: source-serif-pro,'Source Serif Pro',serif;
}
</style>

<!-- Copy from here down -->

<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />

<style>

:root {
  --emap-white: #FFFFFF;
  --emap-black: #33342E;
  --emap-off-white: #F4F4F4;
  --emap-light-grey: #E0E0E0;
  --emap-yellow: #FFDE16;
  --emap-secondary: #8F0D56;
  --emap-secondary2: #E3EDDF;

  --emap-small-font: 14px;
  --emap-large-font: 18px;

  --emap-width: 400px;
  --emap-topbar-height: 68px;
  --emap-bottom-padding: 24px;
}

#event-map *::-webkit-search-cancel-button {
  -webkit-appearance: searchfield-cancel-button;
}

#event-map {
  color: var(--emap-black);
}

#event-map .event-card {
  border: 1px solid var(--emap-light-grey);
  box-shadow: 0 0.5px 0 0 #ffffff inset, 0 1px 2px 0 var(--emap-light-grey);
  margin: var(--emap-small-font);
}

#event-map .event-card-header {
  font-weight: 600;
  background: var(--emap-yellow);
  padding: var(--emap-small-font);
  border-bottom: 1px solid var(--emap-light-grey);
  position: relative;
}

#event-map .event-card-header-title {
  font-weight: bold;
  font-size: var(--emap-large-font);
}
#event-map .event-card-header-type {
  font-weight: 600;
  font-size: var(--emap-small-font);
}
#event-map .event-card-header-rsvp {
  position: absolute;
  right: var(--emap-small-font);
  font-size: var(--emap-small-font);
  top: 50%;
  transform: translateY(-50%);
  background: var(--emap-secondary);
  padding: 5px 10px;
  text-decoration: none;
  color: var(--emap-white);
  font-weight: bold;
}

#event-map .event-card-body {
  background: var(--emap-white);
  padding: var(--emap-small-font);
  font-size: 16px;
  line-height: 24px;
}
#event-map .event-card-body-date,
#event-map .event-card-body-time {
  font-weight: 600;
}
#event-map .event-card-body-addr {
  margin-bottom: 1rem;
}

#event-map .event-map-topbar {
  position: absolute;
  top: 0;
  height: var(--emap-topbar-height);
  padding: var(--emap-small-font);
}

#event-map .event-map-sidebar {
  position: absolute;
  width: var(--emap-width);
  top: var(--emap-topbar-height);
  bottom: 0;
  overflow-y: scroll;
  left: 0;
  z-index: 9999;
  border-top: 1px solid var(--emap-light-grey);
}

#event-map.is-filtering .is-filtered {
  display: none;
}

#event-map .event-map-map {
  position: absolute;
  width: calc(100% - var(--emap-width));
  top: var(--emap-topbar-height);
  left: var(--emap-width);
  bottom: var(--emap-bottom-padding);
  border-top: 1px solid var(--emap-light-grey);
}

#event-map .listings {
  font-family: 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
  background-color: var(--emap-white);
  border: 1px solid var(--emap-white);
}

#event-map ::-webkit-scrollbar {
  width:3px;
  height:3px;
  border-left:0;
  background:rgba(0,0,0,0.1);
}
#event-map::-webkit-scrollbar-track {
  background:none;
}
#event-map::-webkit-scrollbar-thumb {
  background:#000;
  border-radius:0;
}

#event-map .marker {
  border: none;
  cursor: pointer;
  height: 56px;
  width: 56px;
  background-image: url(data:image/jpeg;base64,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);
  background-color: rgba(0, 0, 0, 0);
  background-size: cover;
}

#event-map .clearfix { display:block; }
#event-map .clearfix:after {
  content:'.';
  display:block;
  height:0;
  clear:both;
  visibility:hidden;
}

#event-map .event-map-topbar-text {
  font-size: 22px;
  font-weight: bold;
  margin-right: 5px;
}

#event-map .event-type-search-bar {
  position: relative;
  margin-right: 5px;
  display: inline;
}

#event-map .event-type-select-wrapper {
  display: inline;
}

#event-map .select::after {
  border: 3px solid transparent;
  border-radius: 2px;
  border-right: 0;
  border-top: 0;
  content: " ";
  display: block;
  height: 0.625em;
  margin-top: -0.4375em;
  pointer-events: none;
  position: absolute;
  top: 50%;
  transform: rotate(-45deg);
  transform-origin: center;
  width: 0.625em;
  border-color: #3273dc;
  right: 1.125em;
  z-index: 4;
}

#event-map .select {
  display: inline-block;
  max-width: 100%;
  position: relative;
  vertical-align: top;
  height: 2.5em;
  cursor: pointer;
  font-size: 1em;
  max-width: 100%;
  outline: none;
  font-size: 16px;
}

#event-map .select select::-ms-expand {
  display: none;
}

#event-map .select select {
  -moz-appearance: none;
  -webkit-appearance: none;
  align-items: center;
  border: 1px solid transparent;
  border-radius: 4px;
  box-shadow: none;
  display: inline-flex;
  font-size: 1em;
  height: 2.5em;
  justify-content: flex-start;
  line-height: 1.5;
  padding-bottom: calc(0.5em - 1px);
  padding-left: calc(0.75em - 1px);
  padding-right: calc(0.75em - 1px);
  padding-top: calc(0.5em - 1px);
  position: relative;
  vertical-align: top;
  margin: 0;
  background-color: white;
  border-color: #dbdbdb;
  border-radius: 4px;
  color: #363636;
  padding-right: 2.5em;
}

#event-map .select select:hover {
  border-color: #b5b5b5;
}

#event-map .select:hover::after {
  border-color: #363636;
}

#event-map .select select:focus {
  border-color: #3273dc;
  box-shadow: 0 0 0 0.125em rgba(50, 115, 220, 0.25);
}


#event-map .select select:focus {
  outline: none;
}

#event-map input.search,
#event-map button.toggle {
  padding: 5px;
  margin: 0;
  font-size: var(--emap-large-font);
  line-height: 26px;
  margin-top: -1px;
  border: 2px solid var(--emap-light-grey);
}

#event-map input.search {
  padding-left: 49px;
  box-sizing: border-box;
  border-radius: 0;
  -webkit-appearance: none;
  -webkit-border-radius: 0;
}

#event-map .search-icon {
  background-image: url("data:image/svg+xml,%3Csvg width='18' height='18' viewBox='0 0 18 18' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M11.9649 11.2549H12.7549L17.7449 16.2549L16.2549 17.7449L11.2549 12.7549V11.9649L10.9849 11.6849C9.84488 12.6649 8.36488 13.2549 6.75488 13.2549C3.16488 13.2549 0.254883 10.3449 0.254883 6.75488C0.254883 3.16488 3.16488 0.254883 6.75488 0.254883C10.3449 0.254883 13.2549 3.16488 13.2549 6.75488C13.2549 8.36488 12.6649 9.84488 11.6849 10.9849L11.9649 11.2549ZM2.25488 6.75488C2.25488 9.24488 4.26488 11.2549 6.75488 11.2549C9.24488 11.2549 11.2549 9.24488 11.2549 6.75488C11.2549 4.26488 9.24488 2.25488 6.75488 2.25488C4.26488 2.25488 2.25488 4.26488 2.25488 6.75488Z' fill='%2374756E'/%3E%3C/svg%3E%0A");
  background-size: cover;
  width: 17.5px;
  height: 17.5px;
  position: absolute;
  left: 17.5px;
  top: 50%;
  transform: translateY(-50%);
}

/* Marker tweaks */
#event-map .mapboxgl-popup {
  padding-bottom: 50px;
}

#event-map .mapboxgl-popup-close-button {
  display:none;
}
#event-map .mapboxgl-popup-content {
  font-family: 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
  font-weight: 300;
  font-size: var(--emap-small-font);
  line-height: 22px;
  min-width: var(--emap-width);
  border-radius: 10px;
  box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.15);
  max-height: calc(0.9 * var(--emap-height));
  overflow-y: scroll;
  padding: 28px 30px;
  padding-bottom: 0;
}

#event-map .mapboxgl-popup-content:after {
  content: "";
  display: block;
  height: 30px;
  width: 100%;
}

#event-map .mapboxgl-popup-content p:last-child {
  margin-bottom: 0;
}

#event-map .mapboxgl-popup-content p:first-child {
  margin-top: 0;
}

#event-map .mapboxgl-container .leaflet-marker-icon {
  cursor:pointer;
}

#event-map .mapboxgl-popup-anchor-top > .mapboxgl-popup-content {
  margin-top: 15px;
}

#event-map .mapboxgl-popup-anchor-top > .mapboxgl-popup-tip {
  border-bottom-color: #fdde33;
}

</style>

<div id="event-map">
  <div class='event-map-topbar'>
    <span class='event-map-topbar-text'>
      Filter events:
    </span>
    <div class='event-type-search-bar'>
      <input id='event-text-search' class='search' type='search' placeholder='zipcode, state, or event name'>
      <div class='search-icon'>
      </div>
    </div>
    <div class='event-type-select-wrapper'>
      <div class='select'>
        <select id='event-type-select'>
          <option value=''>All Event Types</option>
        </select>
      </div>
    </div>
  </div>
  <div class='event-map-sidebar' id='event-list-sidebar'>
    <div id='listings' class='listings'>
    </div>
  </div>
  <div id='map' class='event-map-map'>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>

<script>
if (typeof(String.prototype.trim) === "undefined") {
  String.prototype.trim = function() {
    return String(this).replace(/^\s+|\s+$/g, '');
  };
}

if (typeof(Array.prototype.unique) === "undefined") {
  Array.prototype.unique = function() {
    return this.filter(function (value, index, self) {
      return self.indexOf(value) === index;
    });
  }
}

/* Port of strftime() by T. H. Doan (https://thdoan.github.io/strftime/)
 *
 * Day of year (%j) code based on Joe Orost's answer:
 * http://stackoverflow.com/questions/8619879/javascript-calculate-the-day-of-the-year-1-366
 *
 * Week number (%V) code based on Taco van den Broek's prototype:
 * http://techblog.procurios.nl/k/news/view/33796/14863/calculate-iso-8601-week-and-year-in-javascript.html
 */
function strftime(sFormat, date) {
  if (!(date instanceof Date)) date = new Date();
  var nDay = date.getDay(),
    nDate = date.getDate(),
    nMonth = date.getMonth(),
    nYear = date.getFullYear(),
    nHour = date.getHours(),
    aDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
    aMonths = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
    aDayCount = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334],
    isLeapYear = function() {
      return (nYear%4===0 && nYear%100!==0) || nYear%400===0;
    },
    getThursday = function() {
      var target = new Date(date);
      target.setDate(nDate - ((nDay+6)%7) + 3);
      return target;
    },
    zeroPad = function(nNum, nPad) {
      return ((Math.pow(10, nPad) + nNum) + '').slice(1);
    };
  return sFormat.replace(/%[a-z]/gi, function(sMatch) {
    return (({
      '%a': aDays[nDay].slice(0,3),
      '%A': aDays[nDay],
      '%b': aMonths[nMonth].slice(0,3),
      '%B': aMonths[nMonth],
      '%c': date.toUTCString(),
      '%C': Math.floor(nYear/100),
      '%d': zeroPad(nDate, 2),
      '%e': nDate,
      '%F': date.toISOString().slice(0,10),
      '%G': getThursday().getFullYear(),
      '%g': (getThursday().getFullYear() + '').slice(2),
      '%H': zeroPad(nHour, 2),
      '%I': zeroPad((nHour+11)%12 + 1, 2),
      '%j': zeroPad(aDayCount[nMonth] + nDate + ((nMonth>1 && isLeapYear()) ? 1 : 0), 3),
      '%k': nHour,
      '%l': (nHour+11)%12 + 1,
      '%m': zeroPad(nMonth + 1, 2),
      '%n': nMonth + 1,
      '%M': zeroPad(date.getMinutes(), 2),
      '%p': (nHour<12) ? 'AM' : 'PM',
      '%P': (nHour<12) ? 'am' : 'pm',
      '%s': Math.round(date.getTime()/1000),
      '%S': zeroPad(date.getSeconds(), 2),
      '%u': nDay || 7,
      '%V': (function() {
              var target = getThursday(),
                n1stThu = target.valueOf();
              target.setMonth(0, 1);
              var nJan1 = target.getDay();
              if (nJan1!==4) target.setMonth(0, 1 + ((4-nJan1)+7)%7);
              return zeroPad(1 + Math.ceil((n1stThu-target)/604800000), 2);
            })(),
      '%w': nDay,
      '%x': date.toLocaleDateString(),
      '%X': date.toLocaleTimeString(),
      '%y': (nYear + '').slice(2),
      '%Y': nYear,
      '%z': date.toTimeString().replace(/.+GMT([+-]\d+).+/, '$1'),
      '%Z': date.toTimeString().replace(/.+\((.+?)\)$/, '$1')
    }[sMatch] || '') + '') || sMatch;
  });
}

function htmlEscape(s) {
  if (!s) return '';
  return s.
    replace(/&/g, "&amp;").
    replace(/</g, "&lt;").
    replace(/>/g, "&gt;").
    replace(/"/g, "&quot;").
    replace(/'/g, "&#x27;").
    replace(/\//g, "&#x2F;");
}

function linkEscape(s) {
  if (!s) return '';
  const escaped = s.trim().
    replace(/</g, "&lt;").
    replace(/>/g, "&gt;").
    replace(/"/g, "&quot;").
    replace(/'/g, "&#x27;");
  if (escaped.match(/^\s*javascript/i))
    return '';
  else if (escaped.match(/^bit\.ly/))
    return 'https://'+escaped;
  else
    return escaped;
}

function eventCard(ev) {
  return `<div class='event-card-header'>
    <a target='_blank' href='${linkEscape(ev.registration_link)}' class='event-card-header-rsvp'>RSVP</a>
    <div class='event-card-header-type'>
      ${htmlEscape(ev.event_type)}
    </div>
    <div class='event-card-header-title'>
      ${htmlEscape(ev.event_title)}
    </div>
  </div>
  <div class='event-card-body'>
    <div class='event-card-body-date'>
      ${strftime('%B %e, %Y', new Date(ev.start_date))}
    </div>
    <div class='event-card-body-time'>
      ${strftime('%l:%M %p', new Date(ev.start_date))}
    </div>
    <div class='event-card-body-addr'>
      ${htmlEscape(ev.location_name)}
      <br>
      ${htmlEscape(ev.address)}
      <br>
      ${htmlEscape(ev.city)}, ${htmlEscape(ev.state)} ${htmlEscape(ev.zip_code)}
    </div>
    <div class='event-card-body-desc'>
      ${htmlEscape(ev.description)}
    </div>
  </div>`;
}

function emailLink(email) {
  return `<a href="mailto:${htmlEscape(email)}">${htmlEscape(email)}</a>`;
}

function parseDate(s) {
  var parts = s.split('-');
  return new Date(parts[0], parts[1] - 1, parts[2]);
}

function eventName(t) {
  return `<strong class='event-name'>${htmlEscape(t.event_title)}</strong>`;
}

function eventInfo(t) {
  return `
    <dl>
      <dt>Description</dt>
      <dd>${htmlEscape(t.description)}</dd>

      <dt>Event Type</dt>
      <dd>${htmlEscape(t.event_type)}</dd>

      <dt>Location</dt>
      <dd>${t.location_name}<br>${t.address}<br>${t.city}, ${t.state} ${t.zip_code}</dd>

      <dt>Date and Time</dt>
      <dd>
        ${new Date(t.start_date).toLocaleString()} to <br>
        ${new Date(t.end_date).toLocaleString()}
      </dd>

      <dt>Link</dt>
      <dd><a href='${linkEscape(t.registration_link)}'>${htmlEscape(t.registration_link)}</a></dd>

    </dl>
  `;
}

function geoJSONFeature(t) {
  return {
    "type": "Feature",
    "geometry": {
      "type": "Point",
      "coordinates": [t.longitude, t.latitude]
    },
    "properties": t
  }
}

function showMapMobile() {
  $(".sidebar").css({"z-index": "0"});
}

function showListMobile() {
  $(".sidebar").css({"z-index": "9999"});
}

$(document).ready(function() {
  $("#show-map").click(function(){
    showMapMobile();
  });

  $("#show-list").click(function(){
    showListMobile();
  });

  $.ajax({
      type: "GET",
      url: "https://sunrise-trainings-json.s3.amazonaws.com/events.json",
      dataType: "json",
      success: function(data) {
        initMap(data.map_data);
      }
   });
});

function initMap(events) {
  mapboxgl.accessToken = 'pk.eyJ1IjoiYWxhdXJlbnppIiwiYSI6ImNqdDlna2o5ZTA0M2gzeW8zcWQwN3hnNDAifQ.uAXKXOB2I-G3gBXrkXWOrw';

  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v9',
    center: [-112.030293, 39.585733],
    zoom: 2.5
  });

  // Add zoom and rotation controls to the map.
  map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

  var eventsByPos = {};
  var keys = [];
  var eventTypes = new Set([]);

  for (var i = 0; i < events.length; i++) {
    var t = events[i];
    eventTypes.add(t.event_type);
    var key = `${t.latitude}, ${t.longitude}`;
    if (!eventsByPos[key]) {
      eventsByPos[key] = {
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [t.longitude, t.latitude]
        },
        "properties": {
          "events": []
        }
      };
      keys.push(key);
    }
    eventsByPos[key].properties.events.push(t);
  }
  eventTypes = Array.from(eventTypes);
  eventTypes.sort();
  eventTypes.forEach((et) => {
    $('#event-type-select').append(`<option value='${et}'>${et}</option>`);
  });

  function setQueryParam(name, value) {
    const params = new URLSearchParams(window.location.search);
    params.set(name, value);
    window.history.replaceState({}, "", decodeURIComponent(`${window.location.pathname}?${params}`));
  }

  var features = [];
  for (var i = 0; i < keys.length; i++) {
    var feature = eventsByPos[keys[i]];
    feature.properties.searchKey = '';
    for (var j = 0; j < feature.properties.events.length; j++) {
      var event = feature.properties.events[j];
      event['position'] = i;
      event['subindex'] = j;
      feature.properties.searchKey += `position${i}_`;
    }

    features.push(feature);
  }

  map.on('load', function (e) {
    map.addSource("places", {
      "type": "geojson",
      "data": {
        "type": "FeatureCollection",
        "features": features
       }
    });

    buildLocationList(features, events);

    var eventList = new List('event-list-sidebar', {
      listClass: 'listings',
      valueNames: ['event-name']
    });

    function resetFilters() {
      const params = new URLSearchParams(window.location.search);
      const eventType = params.get('eventType');
      const eventSearch = params.get('eventSearch');
      $('#event-type-select').val(eventType);
      $('#event-text-search').val(eventSearch);

      if (eventType || eventSearch) {
        $('#event-map').addClass('is-filtering');
      } else {
        $('#event-map').removeClass('is-filtering');
      }

      let minLat = 1000;
      let maxLat = -1000;
      let minLng = 1000;
      let maxLng = -1000;

      $('.event-card').addClass('is-filtered');
      $('.marker').addClass('is-filtered');

      const remainingEvents = events.filter((ev) => {
        if (eventType && ev.event_type != eventType) {
          return false;
        }
        if (eventSearch) {
          for (let field of ['zip_code', 'event_title', 'state'])
            if (ev[field].toLowerCase().search(eventSearch.toLowerCase()) >= 0)
              return true;
          return false;
        }
        return true;
      });

      remainingEvents.forEach((ev) => {
        $(`#listing-${ev.position}`).removeClass('is-filtered');
        $(`#marker-${ev.position}`).removeClass('is-filtered');
        minLat = Math.min(minLat, ev.latitude);
        maxLat = Math.max(maxLat, ev.latitude);
        minLng = Math.min(minLng, ev.longitude);
        maxLng = Math.max(maxLng, ev.longitude);
      });

      const bounds = [[minLng, minLat], [maxLng, maxLat]];

      map.fitBounds(bounds, {
        padding: 75,
        linear: true,
        maxZoom: 7
      });
    }

    $('#event-type-select').change((jsEv) => {
      setQueryParam('eventType', $(jsEv.currentTarget).val());
      resetFilters();
    });

    $('#event-text-search').on('input change', (jsEv) => {
      setQueryParam('eventSearch', $(jsEv.currentTarget).val());
      resetFilters();
    });

    resetFilters();
  });

  map.on('moveend', function() {
    var my = $('#event-map .mapboxgl-popup')[0];
    if (typeof my !== "undefined") {
      my.style.transform = my.style.transform.replace("-50%", "calc(-50% - 0.5px)");
    }
  });

  // This is where your interactions with the symbol layer used to be
  // Now you have interactions with DOM markers instead
  features.forEach(function(marker, i) {
    // Create an img element for the marker
    var el = document.createElement('div');
    el.id = "marker-" + i;
    el.className = 'marker';
    // Add markers to the map at all points
    new mapboxgl.Marker(el, {offset: [0, -23]})
        .setLngLat(marker.geometry.coordinates)
        .addTo(map);

    el.addEventListener('click', function(e){
        // 1. Close all other popups and display popup for clicked store
        createPopUp(marker);

        // 2. Fly to the point
        flyToStore(marker);

        // 3. Highlight listing in sidebar (and remove highlight for all other listings)
        e.stopPropagation();
        $('#event-map .active').removeClass('active');
        var link = $('.listing-for-feature-'+ i);
        if (link.length) {
          $(link[0]).addClass('active');
          link[0].scrollIntoView({ block: 'nearest', inline: 'start' });
        }
    });
  });

  function flyToStore(currentFeature) {
    map.flyTo({ center: currentFeature.geometry.coordinates });
  }

  function createPopUp(currentFeature) {
    var popUps = document.getElementsByClassName('mapboxgl-popup');
    if (popUps[0]) popUps[0].remove();

    var ts = currentFeature.properties.events;
    var popupHtml = '<div class="events-sublist">';
    for (var i = 0; i < ts.length; i++) {
      var t = ts[i];
      popupHtml += `<div class='event-header event-header-${i}'>${eventName(t)}</div>`;
      popupHtml += `<div class='event-info event-info-${i}'>${eventInfo(t)}</div>`;
    }
    popupHtml += '</div>';

    var popup = new mapboxgl.Popup({ closeOnClick: true, anchor: "left" })
      .on('close', function() { $('#event-map .item').removeClass('active'); })
      .setLngLat(currentFeature.geometry.coordinates)
      .setHTML(popupHtml)
      .addTo(map);
  }

  function buildLocationList(features, events) {
    for (var i = 0; i < events.length; i++) {
      var t = events[i];
      var listings = document.getElementById('listings');
      var listing = listings.appendChild(document.createElement('div'));
      listing.id = "listing-" + i;
      listing.className = "event-card item listing-for-feature-" + t.position;
      listing.innerHTML = eventCard(t);
      listing.dataPosition = t.position;
      listing.dataSubindex = t.subindex;

      listing.addEventListener('click', function(e){
        // Update the currentFeature to the store associated with the clicked link
        var clickedListing = features[this.dataPosition];
        var j = this.dataSubindex;

        // 1. Fly to the point
        flyToStore(clickedListing);

        // 2. Close all other popups and display popup for clicked store
        createPopUp(clickedListing);

        // 3. Highlight listing in sidebar (and remove highlight for all other listings)
        $('#event-map .active').removeClass('active');
        $(this).addClass('active');

        // 4. scroll to entry if it's not visible
        var sublisting = $(`.events-sublist .event-info-${j}`);
        if (j > 0 && sublisting.length) {
          sublisting[0].scrollIntoView({block: "nearest", inline: "start"});
        }
      });
    }
  }
}
</script>
